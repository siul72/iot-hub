create database lukiiot;
CREATE USER 'lukiiot_db_admin'@'localhost' IDENTIFIED BY '`a~K83dc^5nyX[}';
GRANT ALL PRIVILEGES ON lukiiot.* TO 'lukiiot_db_admin'@'localhost' WITH GRANT OPTION;

CREATE USER 'lukiiot_db_user'@'localhost' IDENTIFIED BY 'a~K83dc^5nyX[}';
grant usage on lukiiot.* to 'lukiiot_db_user'@'localhost' identified by 'a~K83dc^5nyX[}';
grant all privileges on lukiiot.* to 'lukiiot_db_user'@'localhost';

use lukiiot;

DROP TABLE IF EXISTS Vehicle;
DROP TABLE IF EXISTS Fleet;
DROP TABLE IF EXISTS Permission;
DROP TABLE IF EXISTS User;
DROP TABLE IF EXISTS Role;
DROP TABLE IF EXISTS Organization;
DROP TABLE IF EXISTS EventDataTag;
DROP TABLE IF EXISTS Translation;
DROP TABLE IF EXISTS Language;

CREATE TABLE Organization (
  organizationId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  name  VARCHAR(32) NOT NULL,
  addressStreet VARCHAR(32) NULL,
  addressPostCode VARCHAR(32) NULL,
  email VARCHAR(32) NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  enabled BOOL NOT NULL DEFAULT TRUE ,
  PRIMARY KEY (organizationId),
  UNIQUE (email),
  UNIQUE (name)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE Role (
  roleId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  name  VARCHAR(32) NOT NULL,
  enabled BOOL NOT NULL default TRUE ,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`roleId`), UNIQUE(name)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE Permission (
  permissionId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  name  VARCHAR(32) NOT NULL,
  object  VARCHAR(32) NOT NULL,
  permission  VARCHAR(32) NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  roleId INT(32) UNSIGNED NULL DEFAULT NULL,
  PRIMARY KEY (permissionId), UNIQUE(name),
  INDEX FK_PermRole (roleId),
  CONSTRAINT UC_PermSet UNIQUE (name,object,permission,roleId),
  CONSTRAINT FK_PermRole FOREIGN KEY (roleId) REFERENCES Role (roleId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE User (
  userId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  login     VARCHAR(32)      NOT NULL,
  firstName VARCHAR(32)      NULL DEFAULT NULL,
  lastName  VARCHAR(32)      NULL DEFAULT NULL,
  password  VARCHAR(32)      NULL DEFAULT NULL,
  salt  VARCHAR(32)      NULL DEFAULT NULL,
  email  VARCHAR(32) NOT NULL,
  language  VARCHAR(16) NOT NULL DEFAULT 'en',
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  organizationId INT(32) UNSIGNED NULL DEFAULT NULL,
  roleId INT(32) UNSIGNED NULL DEFAULT NULL,
  PRIMARY KEY (userId), UNIQUE (login), UNIQUE (email),
  INDEX FK_UserOrg (organizationId),
  INDEX FK_UserRole (roleId),
  CONSTRAINT FK_UserOrg FOREIGN KEY (organizationId) REFERENCES Organization (organizationId),
  CONSTRAINT FK_UserRole FOREIGN KEY (roleId) REFERENCES Role (roleId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

drop table VehicleFavourite;

CREATE TABLE VehicleFavourite (
  favItemId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  userId INT(32) UNSIGNED NULL DEFAULT NULL,
  vehicleId VARCHAR(32) NOT NULL,
  favourite BOOL NOT NULL default TRUE ,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (favItemId),
  INDEX FK_VF_USER (userId),
  INDEX FK_VF_VEHICLE (vehicleId),
  CONSTRAINT UC_VF_U_V UNIQUE (userId, vehicleId),
  CONSTRAINT FK_VF_USER FOREIGN KEY (userId) REFERENCES User (userId),
  CONSTRAINT FK_VF_VEHICLE FOREIGN KEY (vehicleId) REFERENCES Vehicle (vehicleId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

drop table Vehicle;
drop table DataScanCollector;
drop table Fleet;
drop table Configuration;

CREATE TABLE Configuration (
  configurationId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  version  VARCHAR(32) NOT NULL,
  projectCode  VARCHAR(128) NOT NULL,
  hardware  VARCHAR(128) NOT NULL,
  enabled BOOL NOT NULL default TRUE ,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  organizationId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (configurationId),
  INDEX FK_ConfOrg (organizationId),
  UNIQUE (projectCode),
  CONSTRAINT FK_ConfOrg FOREIGN KEY (organizationId) REFERENCES Organization (organizationId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE Fleet (
  fleetId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  name  VARCHAR(32) NOT NULL,
  icon  VARCHAR(32) NOT NULL,
  mapPointer  VARCHAR(32) NOT NULL,
  enabled BOOL NOT NULL default TRUE ,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  configurationId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (fleetId),
  UNIQUE (name),
  INDEX FK_FleetConf (configurationId),
  CONSTRAINT FK_FleetConf FOREIGN KEY (configurationId) REFERENCES Configuration (configurationId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE Vehicle (
  vehicleId VARCHAR(32) NOT NULL,
  vehicleType VARCHAR(32) NOT NULL,
  vehicleNumber VARCHAR (16) NOT NULL ,
  smsNumber VARCHAR(20) NOT NULL,
  protocolVersion VARCHAR(16) NOT NULL,
  timeZone INT(5) SIGNED NOT NULL,
  countryCode VARCHAR(8) NOT NULL,
  daylightSavingTime BOOLEAN NOT NULL,
  enabled BOOLEAN NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  fleetId INT(32) UNSIGNED NULL DEFAULT NULL,
  PRIMARY KEY (vehicleId),
  INDEX FK_Fleet (fleetId),
  CONSTRAINT UC_NAME UNIQUE (vehicleType,vehicleNumber),
  CONSTRAINT FK_Fleet FOREIGN KEY (fleetId) REFERENCES Fleet (fleetId)) ENGINE=InnoDB DEFAULT CHARSET=utf8;

drop table DataScanCollector;

CREATE TABLE DataScanCollector (
  dataScanCollectorId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  pullTime  VARCHAR(32) NOT NULL,
  enabled BOOL NOT NULL default TRUE ,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  fleetId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (dataScanCollectorId),
  UNIQUE (fleetId),
  INDEX FK_DSFleet (fleetId),
  CONSTRAINT FK_DSFleet FOREIGN KEY (fleetId) REFERENCES Fleet (fleetId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

drop table AlarmTagDescription;
drop table SnapShotAlarmTagValue;
drop table HistoryAlarmTagValue;
drop table AlarmEnvironmentData;
drop table AlarmValueHistoryInfo;
drop table SnapShotGenericValue;
drop table DataTag;

CREATE TABLE DataTag (
  tagId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  configurationId INT(32) UNSIGNED DEFAULT NULL,
  sourceTagId INT(32) UNSIGNED DEFAULT NULL,
  dataScanCollectorId INT(32) UNSIGNED DEFAULT NULL,
  name VARCHAR(128) NOT NULL,
  process VARCHAR(32) NOT NULL,
  type VARCHAR(32) NOT NULL,
  engUnits VARCHAR(32) NOT NULL,
  valueType VARCHAR(32) NOT NULL,
  incrementDeadBand VARCHAR(32) NOT NULL,
  decrementDeadBand VARCHAR(32) NOT NULL,
  scale DOUBLE NOT NULL DEFAULT 1,
  preData BOOLEAN NOT NULL,
  postData BOOLEAN NOT NULL,
  enabled BOOLEAN NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (tagId),
  CONSTRAINT UC_SID_NAME UNIQUE (configurationId, sourceTagId, name),
  CONSTRAINT FK_D_CNF FOREIGN KEY (configurationId) REFERENCES Configuration (configurationId),
  CONSTRAINT FK_D_DSC FOREIGN KEY (dataScanCollectorId) REFERENCES DataScanCollector (dataScanCollectorId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE AlarmValueHistoryInfo (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  eventIndex INT(32) NOT NULL DEFAULT 0,
  tagId INT(32) UNSIGNED NULL DEFAULT 0,
  vehicleId VARCHAR(32) NOT NULL,
  eventCodeReference INT(32) NOT NULL DEFAULT 0,
  statusInfo INT(32) NOT NULL DEFAULT 0,
  numberOfEvents INT(32) NOT NULL DEFAULT 0,
  startTimeStamp INT(32) NOT NULL DEFAULT 0,
  startTSMilliseconds INT(32) NOT NULL DEFAULT 0,
  endTimeStamp INT(32) NOT NULL DEFAULT 0,
  endTSMilliseconds INT(32) NOT NULL DEFAULT 0,
  duration BIGINT NOT NULL DEFAULT 0,
  ack BIT NOT NULL DEFAULT FALSE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  CONSTRAINT FK_TAG_INFO FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT UC_TAG_TS UNIQUE (eventIndex,vehicleId,startTimeStamp, startTSMilliseconds)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE AlarmEnvironmentData (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  eventIndex INT(32) UNSIGNED NOT NULL,
  categoryIndex INT(32) UNSIGNED NOT NULL,
  alarmTagHistoryInfoId INT(32) UNSIGNED NOT NULL,
  timeStampSeconds INT(32) NOT NULL DEFAULT 0,
  timeStampMilliSeconds INT(32) NOT NULL DEFAULT 0,
  value VARCHAR(2048) NOT NULL,
  PRIMARY KEY (id),
  CONSTRAINT FK_ALARM_HISTORY FOREIGN KEY (alarmTagHistoryInfoId) REFERENCES AlarmValueHistoryInfo (id),
  CONSTRAINT UC_ALARM_HIST_ID_TS UNIQUE (alarmTagHistoryInfoId, eventIndex, categoryIndex, timeStampSeconds, timeStampMilliSeconds)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE SnapShotAlarmTagValue (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  tagId INT(32) UNSIGNED NULL DEFAULT 0,
  vehicleId VARCHAR(32) NOT NULL,
  timeStamp INT(32) NOT NULL DEFAULT 0,
  milliSeconds INT(32) NOT NULL DEFAULT 0,
  value BIGINT NOT NULL DEFAULT 0,
  scale DOUBLE NOT NULL DEFAULT 1,
  status INT(32) NOT NULL DEFAULT 0,
  ack BIT NOT NULL DEFAULT FALSE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  CONSTRAINT FK_SNAP_TAG FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT UC_TAG_TS UNIQUE (tagId,vehicleId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE SnapShotGenericValue (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  tagId INT(32) UNSIGNED NULL DEFAULT 0,
  vehicleId VARCHAR(32) NOT NULL,
  timeStamp INT(32) NOT NULL DEFAULT 0,
  milliSeconds INT(32) NOT NULL DEFAULT 0,
  value BIGINT NOT NULL DEFAULT 0,
  scale DOUBLE NOT NULL DEFAULT 1,
  status INT(32) NOT NULL DEFAULT 0,
  ack BIT NOT NULL DEFAULT FALSE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX FK_SNAP_GEN_TAG (tagId),
  INDEX FK_S_G_TAG_VEHICLE(vehicleId),
  CONSTRAINT FK_SNAP_GEN_TAG FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT FK_S_G_TAG_VEHICLE FOREIGN KEY (vehicleId) REFERENCES Vehicle (vehicleId),
  CONSTRAINT UC_TAG_GEN_TS UNIQUE (tagId,vehicleId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE HistoryAlarmTagValue (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  tagId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  vehicleId VARCHAR(32) NOT NULL,
  timeStamp INT(32) NOT NULL DEFAULT 0,
  milliSeconds INT(32) NOT NULL DEFAULT 0,
  value BIGINT NOT NULL DEFAULT 0,
  scale DOUBLE NOT NULL DEFAULT 1,
  status INT(32) NOT NULL DEFAULT 0,
  ack BIT NOT NULL DEFAULT FALSE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX FK_HIST_TAG (tagId),
  INDEX FK_HIST_VEHICLE (vehicleId),
  CONSTRAINT FK_HIST_TAG FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT FK_HIST_VEHICLE FOREIGN KEY (vehicleId) REFERENCES Vehicle (vehicleId),
  CONSTRAINT UC_TAG_TS UNIQUE (tagId,vehicleId,timeStamp, milliSeconds)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE HistoryGenericValue (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  tagId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  vehicleId VARCHAR(32) NOT NULL,
  timeStamp INT(32) NOT NULL DEFAULT 0,
  milliSeconds INT(32) NOT NULL DEFAULT 0,
  value BIGINT NOT NULL DEFAULT 0,
  scale DOUBLE NOT NULL DEFAULT 1,
  status INT(32) NOT NULL DEFAULT 0,
  ack BIT NOT NULL DEFAULT FALSE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX FK_HIST_GEN_TAG (tagId),
  INDEX FK_HIST__GEN_VEHICLE (vehicleId),
  CONSTRAINT FK_HIST_GEN_TAG FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT FK_HIST__GEN_VEHICLE FOREIGN KEY (vehicleId) REFERENCES Vehicle (vehicleId),
  CONSTRAINT UC_TAG_TS UNIQUE (tagId,vehicleId,timeStamp, milliSeconds)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE AlarmTagDescription (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  tagId INT(32) UNSIGNED NULL DEFAULT 0,
  language VARCHAR(32) NOT NULL,
  shortDescription VARCHAR(256) NULL,
  longDescription VARCHAR(512) NULL,
  workshopDescription VARCHAR(256) NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  CONSTRAINT FK_Tag FOREIGN KEY (tagId) REFERENCES DataTag (tagId),
  CONSTRAINT UC_TAG_TS UNIQUE (tagId, language)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE Language (
  languageId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  name     VARCHAR(32)      NOT NULL,
  flag VARCHAR(32)      NULL DEFAULT NULL,
  enabled BOOLEAN NOT NULL DEFAULT TRUE,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`languageId`), UNIQUE (`name`)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE Translation (
  translationId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  textId VARCHAR(128) NOT NULL,
  languageId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  translation VARCHAR(256) NULL DEFAULT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (translationId),
  UNIQUE (textId, languageId),
  INDEX IX_TranslationLang (languageId),
  CONSTRAINT FK_TranslationLang FOREIGN KEY (languageId) REFERENCES Language (languageId)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;


DROP TABLE CategorySignalMap;
DROP TABLE AlarmCategory;
DROP TABLE AlarmBuffer;

CREATE TABLE AlarmBuffer (
  bufferId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  configurationId INT(32) UNSIGNED NOT NULL DEFAULT 0,
  bufferIndex INT(32) UNSIGNED NOT NULL,
  sampleSeconds INT(32) UNSIGNED NOT NULL,
  sampleMilliSeconds INT(32) UNSIGNED NOT NULL,
  numberOfSamples INT(32) UNSIGNED NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (bufferId),
  CONSTRAINT UC_BUFFER_PROJECT UNIQUE (configurationId,bufferIndex),
  INDEX FK_BufferConf (configurationId),
  CONSTRAINT FK_BufferConf FOREIGN KEY (configurationId) REFERENCES Configuration (configurationId)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE AlarmCategory (
  categoryId INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  categoryIndex INT(32) UNSIGNED NOT NULL,
  bufferId INT(32) UNSIGNED NOT NULL,
  name VARCHAR(64) NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (categoryId),
  CONSTRAINT UC_PROJECT_NAME UNIQUE (bufferId,categoryIndex,name),
  INDEX IX_AlarmBuffer (bufferId),
  CONSTRAINT FK_BUFFER FOREIGN KEY (bufferId) REFERENCES AlarmBuffer (bufferId)

) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE CategorySignalMap (
  id INT(32) UNSIGNED NOT NULL AUTO_INCREMENT,
  categoryId INT(32) UNSIGNED NOT NULL,
  signalId INT(32) UNSIGNED NOT NULL,
  signalSize INT(32) UNSIGNED NOT NULL,
  position INT(32) UNSIGNED NOT NULL,
  updateBy VARCHAR(32) NOT NULL DEFAULT '',
  updateTime TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX IX_Category (categoryId),
  CONSTRAINT FK_Category FOREIGN KEY (categoryId) REFERENCES AlarmCategory (categoryId),
  CONSTRAINT UC_CATID_SIGID UNIQUE (categoryId, signalId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;








